<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bagalkot Navigation â€“ MapmyIndia Hybrid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Load MapmyIndia Interactive Maps API -->
  <script src="https://apis.mapmyindia.com/advancedmaps/v1/a0c009c001123e82338fdc26957f3a6b/map_load?v=1.5"></script>
  <style>
    #map { height: 100vh; width: 100%; }
    #instructions {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      z-index: 1000;
      max-width: 300px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="instructions">Navigation instructions will appear here.</div>

<script>
  // Initialize MapmyIndia map in Hybrid view
  var map = new MapmyIndia.Map('map', {
    center: [15.9553, 75.6549],  // Default center (Bagalkot)
    zoom: 14,
    hybrid: true  // Activates satellite + labels hybrid view
  });

  var driverMarker, routePolyline, upcomingSegment;
  var routeCoords = [];

  // Load your CPP-generated route
  fetch('bagalkot_cpp_route.json')
    .then(res => res.json())
    .then(data => {
      routeCoords = data.map(c => [c[0], c[1]]);
      routePolyline = L.polyline(routeCoords, {color: 'blue', weight: 5}).addTo(map);
      map.fitBounds(routePolyline.getBounds());
      L.marker(routeCoords[routeCoords.length - 1]).addTo(map).bindPopup("Destination");
    })
    .catch(err => console.error("Error loading CPP route:", err));

  // Driver location tracking
  function onLocationFound(e) {
    var loc = e.latlng;
    if (!driverMarker) {
      driverMarker = L.marker(loc).addTo(map).bindPopup("You are here").openPopup();
    } else {
      driverMarker.setLatLng(loc);
    }
    map.setView(loc, map.getZoom(), {animate: true});
    updateNavigation(loc);
  }

  function onLocationError() {
    alert("Please enable location/GPS permissions to use navigation.");
  }

  map.on('locationfound', onLocationFound);
  map.on('locationerror', onLocationError);

  map.locate({setView: true, maxZoom: 18, watch: true, enableHighAccuracy: true});

  function updateNavigation(loc) {
    if (!routeCoords.length) return;
    let minD = Infinity, idx = 0;
    routeCoords.forEach((pt, i) => {
      let d = map.distance(loc, pt);
      if (d < minD) { minD = d; idx = i; }
    });
    let seg = routeCoords.slice(idx, idx + 5);
    if (upcomingSegment) map.removeLayer(upcomingSegment);
    upcomingSegment = L.polyline(seg, {color: 'green', weight: 6}).addTo(map);
    document.getElementById('instructions').innerHTML = 
      `Approaching segment ${idx + 1} of ${routeCoords.length}`;
  }
</script>

</body>
</html>
